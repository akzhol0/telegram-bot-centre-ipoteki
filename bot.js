const TelegramBot = require("node-telegram-bot-api");
const sqlite3 = require("sqlite3").verbose();

const TOKEN = "8257490360:AAGxLEH456Gdkij3vBFSKwEJKyTMlVNMuaE";
const bot = new TelegramBot(TOKEN, { polling: true });

const db = new sqlite3.Database("users.db");

// Создание таблицы пользователей
db.run("CREATE TABLE IF NOT EXISTS users (chat_id INTEGER PRIMARY KEY, day INTEGER DEFAULT 0)");

// ======= Сообщения для рассылки =======
const dailyMessages = [
  `🏡 День 1
Ошибки при подаче заявки на ипотеку
Многие люди совершают типичные ошибки при оформлении ипотеки, из-за которых банки отказывают в кредите. Первая ошибка — неполный пакет документов. Всегда проверяйте, что у вас есть паспорт, справка о доходах, документы на имущество и дополнительные бумаги, которые могут запросить банки. Вторая — скрытые кредиты или неоплаченные займы, которые снижают кредитный рейтинг. Третья ошибка — неправильный выбор банка. Не все банки предлагают одинаковые условия, поэтому важно сравнивать ставки, комиссии и требования к заемщикам. Четвертая — недостоверные данные в документах, особенно по доходу. Любое искажение может стать основанием для отказа. Пятая — отсутствие первоначального взноса. Чем выше первый взнос, тем выше шанс одобрения. Наш совет: заранее соберите все документы, убедитесь в чистоте кредитной истории и проконсультируйтесь со специалистом, чтобы повысить вероятность успешного получения ипотеки.`,

  `💡 День 2
Секреты одобрения ипотеки
Одним из ключевых факторов одобрения является правильно подготовленный пакет документов и чистая кредитная история. Банки обращают внимание на стабильность дохода, наличие долговых обязательств и уровень финансовой дисциплины. Важно заранее проверить свой кредитный рейтинг, при необходимости закрыть просрочки и уточнить сумму долгов. Второй аспект — правильный выбор банка и программы. Некоторые банки предлагают более выгодные условия для молодых семей, госпрограмм или клиентов с первоначальным взносом. Рекомендуется сравнивать процентные ставки, комиссии и дополнительные услуги. Третий момент — общение с менеджером. Четкое и честное объяснение вашей ситуации и доходов помогает сотрудникам банка правильно оценить заявку. Четвёртый — подготовка резервного плана. Иногда лучше подать заявку в несколько банков одновременно, чтобы увеличить шансы на одобрение.`,

  `📊 День 3
Оптимальный первоначальный взнос и срок кредита
Первоначальный взнос влияет на процентную ставку и общую сумму переплаты. Чем выше первый взнос, тем меньше риск для банка и, как следствие, ниже ставка. Рекомендуется рассчитывать оптимальный размер взноса, исходя из своих финансовых возможностей, чтобы оставались деньги на непредвиденные расходы. Также важно правильно выбрать срок кредита. Долгий срок снижает ежемесячный платёж, но увеличивает общую переплату по процентам. Короткий срок — быстрее закрываете кредит, но платёж выше. Оптимизация этих параметров помогает сэкономить средства и уменьшить финансовую нагрузку. Используйте онлайн-калькуляторы и консультации специалистов, чтобы подобрать вариант, который подходит именно вам.`,

  `📝 День 4
Увеличиваем шансы на одобрение ипотеки
Даже при сложной финансовой ситуации возможно получить одобрение. Важно следить за кредитной историей, оплачивать текущие кредиты вовремя и закрывать просрочки. Банки любят стабильность, поэтому подтверждение дохода документами за последние 6–12 месяцев увеличивает доверие. Подготовьте документы, которые показывают вашу платежеспособность: справки о доходах, договоры аренды, подтверждение собственности. Также обратите внимание на программу банка: для молодых семей, госпрограммы или ипотека с первоначальным взносом может облегчить процесс. Консультация со специалистом поможет выбрать подходящий банк и минимизировать риски отказа.`,

  `🔹 День 5
Разбор реального кейса
Один из наших клиентов с минимальным доходом смог оформить ипотеку на квартиру мечты. Мы помогли собрать полный пакет документов, правильно выбрать банк и программу. Кроме того, мы подготовили расчёт первоначального взноса и платежей, чтобы банк видел реальную платежеспособность клиента. Важно: каждая ситуация уникальна, поэтому всегда лучше консультироваться со специалистом. Наши советы помогли избежать ошибок, ускорили процесс одобрения и сделали оформление прозрачным и понятным.`,

  `💡 День 6
Выбор банка и программы
При выборе банка ориентируйтесь не только на процентную ставку, но и на условия программы: страхование, комиссии, требования к доходу. Молодые семьи и госпрограммы могут предложить сниженные ставки и бонусы. Подготовьте документы заранее и узнайте о льготных условиях. Иногда лучше выбрать банк, который предлагает комплексное сопровождение — это экономит время и уменьшает вероятность ошибок. Сравнивайте несколько программ, учитывайте свои возможности и цели, и консультируйтесь с экспертом, чтобы выбрать оптимальный вариант.`,

  `🏠 День 7
Чек-лист для подготовки к покупке квартиры
Перед подачей заявки убедитесь, что все документы собраны: паспорт, справки о доходах, документы на имущество, справки о задолженностях. Рассчитайте оптимальный первоначальный взнос и ежемесячный платеж. Проверьте кредитную историю и при необходимости исправьте ошибки. Составьте список вопросов для банка и подготовьте дополнительные подтверждения дохода. Используйте онлайн-калькуляторы, чтобы проверить соответствие дохода и платежа. Следуя этому чек-листу, вы значительно повышаете шансы на успешное оформление ипотеки и делаете процесс прозрачным и предсказуемым.`
];

// ======= Обработчики команд =======
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  db.run("INSERT OR IGNORE INTO users(chat_id) VALUES(?)", [chatId]);
  bot.sendMessage(chatId, firstMessage);
});

bot.onText(/^\/help$/i, (msg) => bot.sendMessage(msg.chat.id, commands));
bot.onText(/^\/phone$/i, (msg) => bot.sendMessage(msg.chat.id, phoneInformation));
bot.onText(/^\/about$/i, (msg) => bot.sendMessage(msg.chat.id, about));

// ======= Функция ежедневной рассылки =======
function broadcastDaily() {
  db.all("SELECT chat_id, day FROM users", [], (err, rows) => {
    if (err) return console.error(err);
    rows.forEach(row => {
      const dayIndex = row.day || 0;
      if(dayIndex < dailyMessages.length){
        bot.sendMessage(row.chat_id, dailyMessages[dayIndex]).catch(console.error);
        // Обновляем день пользователя
        db.run("UPDATE users SET day = ? WHERE chat_id = ?", [dayIndex + 1, row.chat_id]);
      }
    });
  });
}

setInterval(broadcastDaily, 60 * 1000); // 60 000 мс = 1 минута

const firstMessage = "👋 Добро пожаловать в Центр Ипотеки Астана!\n" +
  "\n" +
  "🏡 Наша миссия — помогать людям приобретать жильё, упрощая процесс оформления ипотеки и убирая все барьеры. Мы верим, что каждый заслуживает шанс осуществить свою мечту о собственном доме.\n" +
  "\n" +
  "✨ В этом боте вы получите:\n" +
  "— ежедневные рассылки и секреты о том, как выгодно оформить ипотеку;\n" +
  "— напоминания и ссылки на вебинары;\n" +
  "— полезные материалы и чек-листы, которые упростят ваш путь.\n" +
  "\n" +
  "🤝 Наши ценности — доверие, прозрачность, профессионализм и командная работа. Мы рядом с вами на каждом шаге, чтобы процесс покупки жилья был простым и понятным.\n" +
  "\n" +
  "☎ Для консультаций:\n" +
  "— по WhatsApp +7 706 429 50 50\n" +
  "— по телефону +7 700 786 86 85\n" +
  "\n" +
  "📲 Instagram: center_ipoteki_astana\n" +
  "\n" +
  "👉 Начнём путь к вашей квартире уже сегодня!\n" +
  "\n" +
  'Напишите !help чтобы посмотреть все доступные команды.'

const phoneInformation = "☎ Для консультаций:\n" +
  "— по WhatsApp +7 706 429 50 50\n" +
  "— по телефону +7 700 786 86 85"

const commands = "📲 Все команды: \n" +
  "!help - Чтобы посмотреть все команды \n" +
  "!phone - Средства связи \n" +
  "!about - О нас \n";

const about = "🏡 Наша миссия — помогать людям приобретать жильё, упрощая процесс оформления ипотеки и убирая все барьеры. Мы верим, что каждый заслуживает шанс осуществить свою мечту о собственном доме.\n"
